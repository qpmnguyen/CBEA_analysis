---
title: "Type I error simulations at the single sample level"
author: "Quang Nguyen"
date: "10/6/2020"
output: html_document
  toc_float: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading parameters and simulated data sets  

```{r loadings, message=FALSE, warning=FALSE}
library(tidyverse)
library(furrr)
library(tictoc)
library(MASS)
library(ggsci)
library(progressr)
library(patchwork)
source("cilr.R")
source("simulations.R")
source("utils.R")

# object file is large and not included. 
fdr_sim <- readRDS(file = "objects/parameters_fdr_sim.rds")
```

# Score estimation 

Estimating scores using `furrr` package.  

```{r estimate_scores, cache = T}
tic()
plan(multiprocess, workers = round(availableCores()/2,0))
with_progress({
  p <- progressor(steps = nrow(fdr_sim))
  fdr_sim$scores_cilr <- future_map(fdr_sim$sim, .f = ~{
    p()
    simple_cilr(X = .x$X, A = .x$A, preprocess = T, pcount = 1, abs = F)
  })
})
plan(sequential)
toc()
tic()
plan(multiprocess, workers = round(availableCores()/2,0))
with_progress({
  p <- progressor(steps = nrow(fdr_sim))
  fdr_sim$label_wc <- map(fdr_sim$sim,.f = ~{
    p()
    wc_test(X = .x$X, A = .x$A, thresh = 0.05, preprocess = T, pcount = 1, alt = "greater")
  })
})
plan(sequential)
toc()
```

After estimating scores, we can generate labels using various ways 
```{r generate_labels}
# generating labels with threshold 
# using raw scores and standard normal distribution  
fdr_sim$label_cilr_raw <- map(fdr_sim$scores_cilr, .f = ~cilr_eval(scores = .x, alt = "greater", thresh = 0.05, resample = F))
fdr_sim$label_cilr_norm <- map2(fdr_sim$scores_cilr, fdr_sim$sim, .f = ~cilr_eval(scores = .x, distr = "norm", alt = "greater", thresh = 0.05, resample = T, 
                                                                        X = .y$X, A = .y$A))
fdr_sim$label_cilr_t <- map2(fdr_sim$scores_cilr, fdr_sim$sim, .f = ~cilr_eval(scores = .x, distr = "t", alt = "greater", thresh = 0.05, resample = T, 
                                                                               X = .y$X, A = .y$A))

# generating fdr comparable statistics 
fdr_sim$fdr_cilr_raw <- map(fdr_sim$label_cilr_raw, .f = ~calculate_statistic(eval = "fdr", pred = .x))
fdr_sim$fdr_cilr_norm <- map(fdr_sim$label_cilr_norm, .f = ~calculate_statistic(eval = "fdr", pred = .x))
fdr_sim$fdr_wc <- map(fdr_sim$label_wc, .f = ~calculate_statistic(eval = "fdr", pred = .x))
fdr_sim$fdr_cilr_t <- map(fdr_sim$label_cilr_t, .f = ~calculate_statistic(eval = "fdr", pred = .x))
```



## Plots 

```{r evaluation_plots}
plot_df <- fdr_sim %>% unnest(starts_with("fdr")) %>% dplyr::select(!starts_with(c("label", "scores", "sim"))) %>%
  pivot_longer(starts_with("fdr")) %>% unnest(data) 
plot_df <- plot_df %>% dplyr::rename("Set Size" = "n_inflate", "Inter-taxa Correlation" = "b_rho")
print(head(plot_df))
#plot_df <- plot_df %>% filter(name != "fdr_cilr_resample")
plt <- ggplot(plot_df, aes(y = value, x = b_spar, col = name)) + geom_point(size = 3) +
  scale_color_nejm(labels = c("cILR normal", "cILR raw", "cILR t", "Wilcoxon Rank Sum")) + 
  geom_line() + geom_hline(yintercept = 0.05, col = "red") +  
  facet_grid(`Inter-taxa Correlation` ~ `Set Size`, scales = "free_y", labeller = label_both) +
  labs(col = "Evaluation Models", x = "Sparsity", y = "Type I error rate (N = 10,000, alpha = 0.05)") + 
  theme_bw()
plt
ggsave(plt, filename = "docs/manuscript/figures/fdr_single_sample.png", 
       dpi = 300, width = 10, height = 10)
```